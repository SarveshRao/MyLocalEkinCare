= javascript_include_tag "jquery"

:javascript
  (function() {
    var _fbq = window._fbq || (window._fbq = []);
    if (!_fbq.loaded) {
      var fbds = document.createElement('script');
      fbds.async = true;
      fbds.src = '//connect.facebook.net/en_US/fbds.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(fbds, s);
      _fbq.loaded = true;
    }
    _fbq.push(['addPixelId', '1439089473071327']);
    })();
    window._fbq = window._fbq || [];
    window._fbq.push(['track', 'PixelInitialized', {}]);

    <!-- Google Code for Remarketing Tag -->
    <!--------------------------------------------------
    --------------------------------------------------->
    /* <![CDATA[ */
    var google_conversion_id = 953531478;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
    /* ]]> */
%script{:src => "//www.googleadservices.com/pagead/conversion.js", :type => "text/javascript"}
%noscript
  %div{:style => "display:inline;"}
    %img{:alt => "", :height => "1", :src => "//googleads.g.doubleclick.net/pagead/viewthroughconversion/953531478/?value=0&amp;guid=ON&amp;script=0", :style => "border-style:none;", :width => "1"}/
%noscript
  %img{:alt => "", :height => "1", :src => "https://www.facebook.com/tr?id=1439089473071327&amp;ev=PixelInitialized", :style => "display:none", :width => "1"}/

= content_for :title, 'Sign in'

%section#content.m-t-lg.wrapper-md.animated.fadeInUp
  .container.aside-xl
    %section.m-b.p-b
      %header.text-center
        %a.h3.font-bold{href: root_path} eKincare
    %section.m-b-lg
      = form_for(resource, as: resource_name, url: session_path(resource_name)) do |f|
        .list-group
          Please enter your registered phone number to receive a One Time Password to login.
          .list-group-item
            = f.text_field :mobile_number, {ajax_path: customers_send_otp_path, id: 'mobile_number', class: 'numeric form-control no-border p-t-n', placeholder: 'Enter your registered mobile number',autofocus: true, required: true, minlength: 10 }
          .list-group-item.after_mobile_number_entry
            = f.text_field :otp, {id: 'otp_code', class: 'numeric form-control no-border p-t-n', placeholder: 'One Time Password',autofocus: true, required: true, minlength: 6}
        = f.submit 'Sign in', {class: 'btn btn-lg btn-primary btn-block after_mobile_number_entry'}
        %p.text-muted.text-center
          %small
            %a.m-b-sm.text-center#send_otp_link{href: "#", ajax_path: customers_send_otp_path} Resend OTP
        %p.text-muted.text-center
          %small Do not have an account?
        %a.btn.btn-lg.btn-default.btn-block{href: new_registration_path(resource_name)} Create an account
%footer#footer
  .text-center.padder
    %p
      %small.current_year

:javascript
  $(document).ready(function(){
    $('.current_year').text("\© " + new Date().getFullYear() + " eKincare");
    //Mobile number validation
    $(".numeric").keydown(function (e) {
      // Allow: backspace, delete, tab, escape, enter and .
      if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
              // Allow: Ctrl+A
          (e.keyCode == 65 && e.ctrlKey === true) ||
              // Allow: home, end, left, right, down, up
          (e.keyCode >= 35 && e.keyCode <= 40)) {
          // let it happen, don't do anything
          return;
      }
      // Ensure that it is a number and stop the keypress
      if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
          e.preventDefault();
      }

      if($(this).attr('id') == 'mobile_number')
      {
        var pattern_mobile_number = /^\d{10}$/;
        if (pattern_mobile_number.test($(this).val())) {
          e.preventDefault();
        }
      }

      if($(this).attr('id') == 'otp_code')
      {
        var pattern_otp = /^\d{6}$/;
        if (pattern_otp.test($(this).val())) {
          e.preventDefault();
        }
      }
    });

    $('#mobile_number').blur(function(){
      if(/^\d{10}$/.test($(this).val()))
        sendOTP($(this));
    });

    $("#send_otp_link").click(function(){
      sendOTP($(this));
    });

    var sendOTP = function(that){
      $.ajax({
        type: "POST",
        url: $(that).attr('ajax_path'),
        data: {mobile_number: $('#mobile_number').val()},
        success: function(page){
          if(page.statusCode == 404)
          {
            $('#invalid_user_id, #signed_out').remove();
            $('.alert.alert-danger.text-center, .alert.alert-success.text-center').remove();
            var invalid_user = $('<div id="invalid_user_id" class="alert alert-danger text-center"> <button class="close" data-dismiss="alert" type="button">×</button> <i class="fa fa-ok-sign"></i> Mobile number you have entered is not registered with eKincare. Please register before you login. </div>');
            $('#content').prepend(invalid_user);
          }
          if(page.statusCode == 200)
          {
            var received_otp = $('<div id="signed_out" class="alert alert-success text-center"> <button class="close" data-dismiss="alert" type="button">×</button> <i class="fa fa-ok-sign"></i> We have sent OTP to your mobile. Please enter the OTP to login. OTP is valid only for next 15 minutes </div>');
            $('#content').prepend(received_otp);
          }
        },
        error: function(data){
          console.log(data);
        },
        dataType: 'json'
      });
    };
  });